<%- include('partials/header', { 
    title: '–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
    stylesheet: '/css/admin.css',
    admin: true
}) %>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
<div id="editEventModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editEventModal')">&times;</span>
        <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h2>
        <form id="editEventForm" action="/admin/events/update" method="POST">
            <input type="hidden" name="eventId" id="editEventId">
            
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" name="title" id="editEventTitle" required>
            </div>
            
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea name="description" id="editEventDescription" rows="4" required></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</label>
                    <input type="datetime-local" name="event_date" id="editEventDate" required>
                </div>
                
                <div class="form-group">
                    <label>–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</label>
                    <input type="number" name="max_participants" id="editEventMaxParticipants" min="1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>–õ–æ–∫–∞—Ü–∏—è:</label>
                    <select name="location_id" id="editEventLocation" required>
                        <% locations.forEach(location => { %>
                            <option value="<%= location.id %>">
                                <%= location.metro_station %> (<%= location.address %>)
                            </option>
                        <% }) %>
                    </select>
                </div>
            </div>

            <div class="form-controls">
                <button type="button" class="btn-cancel" onclick="closeModal('editEventModal')">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–∫–∞—Ü–∏–∏ -->
<div id="editLocationModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editLocationModal')">&times;</span>
        <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞—Ü–∏—é</h2>
        <form id="editLocationForm" action="/admin/locations/update" method="POST">
            <input type="hidden" name="locationId" id="editLocationId">
            
            <div class="form-group">
                <label>–°—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ:</label>
                <input type="text" name="metro_station" id="editMetroStation" required>
            </div>
            
            <div class="form-group">
                <label>–ê–¥—Ä–µ—Å:</label>
                <input type="text" name="address" id="editAddress" required>
            </div>

            <div class="form-controls">
                <button type="button" class="btn-cancel" onclick="closeModal('editLocationModal')">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </form>
    </div>
</div>
<main class="admin-container">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
    <nav class="admin-tabs">
        <a href="#users" class="tab-link active">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
        <a href="#events" class="tab-link">üéâ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
        <a href="#attendance" class="tab-link">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</a>
        <a href="#locations" class="tab-link">üìç –õ–æ–∫–∞—Ü–∏–∏</a>
        <a href="#stats" class="tab-link">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
    </nav>

    <div id="attendance" class="tab-pane">
        <h2 class="section-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏–π</h2>
        
        <div class="filters">
            <select id="eventFilter">
                <% events.forEach(event => { %>
                    <option value="<%= event.id %>"><%= event.title %></option>
                <% }) %>
            </select>
        </div>

        <div class="attendance-list" id="attendanceList">
            <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ AJAX -->
        </div>
    </div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-content">
        <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <div id="users" class="tab-pane active">
            <h2 class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            
            <div class="scroll-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–§–ò–û</th>
                            <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                            <th>Email</th>
                            <th>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(user => { %>
                            <tr>
                                <td><%= user.id %></td>
                                <td><%= user.last_name %> <%= user.first_name %></td>
                                <td><%= new Date(user.birth_date).toLocaleDateString('ru-RU') %></td>
                                <td><%= user.email %></td>
                                <td><%= user.confirmed ? '‚úÖ' : '‚ùå' %></td>
                                <td>
                                    <% if (!user.confirmed) { %>
                                        <form action="/admin/confirm-user/<%= user.id %>" method="POST">
                                            <button type="submit" class="btn-confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                                        </form>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
        <div id="events" class="tab-pane">
            <h2 class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏</h2>
            
            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
            <div class="form-container">
                <button onclick="toggleEventForm()" class="btn-add">‚ûï –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
                
                <form id="eventForm" action="/admin/events" method="POST" class="hidden-form">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                        <input type="text" name="title" required>
                    </div>
                    
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea name="description" rows="4" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</label>
                            <input type="datetime-local" name="event_date" required>
                        </div>
                        
                        <div class="form-group">
                            <label>–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</label>
                            <input type="number" name="max_participants" min="1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>–ì–æ—Ä–æ–¥:</label>
                            <select name="city_id" id="citySelect" required>
                                <% cities.forEach(city => { %>
                                    <option value="<%= city.id %>"><%= city.name %></option>
                                <% }) %>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>–£–ª–∏—Ü–∞:</label>
                            <select name="street_id" id="streetSelect" required>
                                <!-- Streets will be populated via AJAX -->
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–¢–µ–º–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</label>
                        <select name="theme_id" required>
                            <% themes.forEach(theme => { %>
                                <option value="<%= theme.id %>"><%= theme.name %></option>
                            <% }) %>
                        </select>
                    </div>

                    <button type="submit" class="btn-save">–°–æ–∑–¥–∞—Ç—å</button>
                </form>
            </div>

            <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
            <form id="editEventForm" action="/admin/events/update" method="POST" class="hidden-form">
                <input type="hidden" name="eventId" id="editEventId">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <input type="text" name="title" id="editEventTitle" required>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea name="description" id="editEventDescription" rows="4" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</label>
                        <input type="datetime-local" name="event_date" id="editEventDate" required>
                    </div>
                    <div class="form-group">
                        <label>–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</label>
                        <input type="number" name="max_participants" id="editEventMaxParticipants" min="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–õ–æ–∫–∞—Ü–∏—è:</label>
                        <select name="location_id" id="editEventLocation" required>
                            <% locations.forEach(location => { %>
                                <option value="<%= location.id %>">
                                    <%= location.metro_station %> (<%= location.address %>)
                                </option>
                            <% }) %>
                        </select>
                    </div>
                </div>
                <div class="form-controls">
                    <button type="button" onclick="closeEditForm()" class="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>

            <!-- –°–ø–∏—Å–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
            <div class="scroll-container">
                <div class="cards-grid">
                    <% events.forEach(event => { %>
                        <div class="event-card">
                            <h3><%= event.title %></h3>
                            <div class="event-details">
                                <p>üìÖ <%= new Date(event.event_date).toLocaleString() %></p>
                                <p>üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <%= event.participants %></p>
                                <p>üìç <%= event.address %></p>
                            </div>
                            <div class="event-actions">
                                <form action="/admin/events/delete/<%= event.id %>" method="POST">
                                    <button type="submit" class="btn-delete">–£–¥–∞–ª–∏—Ç—å</button>
                                </form>
                                <button 
                                    onclick="openEditForm(
                                        '<%= event.id %>',
                                        '<%= event.title %>',
                                        '<%= event.description %>',
                                        '<%= event.event_date.toISOString().slice(0,16) %>',
                                        '<%= event.location_id %>',
                                        '<%= event.max_participants %>'
                                    )" 
                                    class="btn-edit"
                                >
                                    ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –õ–æ–∫–∞—Ü–∏–∏ -->
        <div id="locations" class="tab-pane">
            <h2 class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏—è–º–∏</h2>
            
            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–æ–∫–∞—Ü–∏–∏ -->
            <div class="form-container">
                <form action="/admin/locations" method="POST" class="inline-form">
                    <div class="form-group">
                        <label>–°—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ:</label>
                        <input type="text" name="metro_station" required>
                    </div>
                    <div class="form-group">
                        <label>–ê–¥—Ä–µ—Å:</label>
                        <input type="text" name="address" required>
                    </div>
                    <button type="submit" class="btn-add">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
                </form>
            </div>

            <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–∫–∞—Ü–∏–∏ -->
            <form id="editLocationForm" action="/admin/locations/update" method="POST" class="hidden-form">
                <input type="hidden" name="locationId" id="editLocationId">
                <div class="form-group">
                    <label>–°—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ:</label>
                    <input type="text" name="metro_station" id="editMetroStation" required>
                </div>
                <div class="form-group">
                    <label>–ê–¥—Ä–µ—Å:</label>
                    <input type="text" name="address" id="editAddress" required>
                </div>
                <div class="form-controls">
                    <button type="button" onclick="closeLocationForm()" class="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>

            <!-- –°–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü–∏–π -->
            <div class="scroll-container">
                <div class="cards-grid">
                    <% locations.forEach(location => { %>
                        <div class="location-card">
                            <div class="location-info">
                                <h3>üöá <%= location.metro_station %></h3>
                                <p>üìç <%= location.address %></p>
                            </div>
                            <div class="location-actions">
                                <button 
                                    onclick="openLocationEdit(
                                        '<%= location.id %>',
                                        '<%= location.metro_station %>',
                                        '<%= location.address %>'
                                    )" 
                                    class="btn-edit"
                                >
                                    ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                <form action="/admin/locations/delete/<%= location.id %>" method="POST">
                                    <button type="submit" class="btn-delete">–£–¥–∞–ª–∏—Ç—å</button>
                                </form>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="stats" class="tab-pane">
            <h2 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π</h2>
            <div class="stats-container">
                <div class="stat-box">
                    <h3>üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <% if (usersActivity.length > 0) { %>
                        <ul class="top-list">
                            <% usersActivity.forEach(user => { %>
                                <li>
                                    <span><%= user.name %></span>
                                    <span><%= user.attended_events %>/<%= user.total_events %></span>
                                </li>
                            <% }) %>
                        </ul>
                    <% } else { %>
                        <p class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
                    <% } %>
                </div>

                <!-- –í —Ä–∞–∑–¥–µ–ª–µ "–¢–æ–ø –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π" -->
                <div class="stat-box">
                    <h3>üèÜ –¢–æ–ø –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h3>
                    <% if (topEvents.length > 0) { %>
                        <ul class="top-list">
                            <% topEvents.forEach(event => { %>
                                <li>
                                    <span><%= event.title %></span>
                                    <span><%= event.attended %>/<%= event.participants %></span>
                                </li>
                            <% }) %>
                        </ul>
                    <% } else { %>
                        <p class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö</p>
                    <% } %>
                </div>
                <div class="stat-box">
                  <h3>üìÖ –ü—Ä–æ—à–µ–¥—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
                  <% if (pastEvents.length > 0) { %>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
                                <th>–ü—Ä–∏—à–ª–∏</th>
                                <th>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</th> <!-- –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                            </tr>
                        </thead>
                        <tbody>
                            <% events.forEach(event => { %>
                                <tr>
                                    <td><%= event.title %></td>
                                    <td><%= event.event_date.toLocaleDateString() %></td>
                                    <td><%= event.participants %></td>
                                    <td><%= event.attended_count %></td>
                                    <td>
                                        <% if (event.participants > 0) { %>
                                            
                                                <button 
                                                    onclick="showAttendance(<%= event.id %>)" 
                                                    class="btn-confirm"
                                                    <%= event.participants === 0 ? 'disabled' : '' %>
                                                >
                                                    ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                                                </button>
                                            

                                        <% } else { %>
                                            <span class="no-data">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                  <% } else { %>
                    <p>–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>
                  <% } %>
                </div>
            </div>
        </div>
    </div>
</main>

<script>

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    document.getElementById('eventFilter').addEventListener('change', async (e) => {
        const eventId = e.target.value;
        const response = await fetch(`/admin/attendance/${eventId}`);
        const data = await response.json();
        
        const list = document.getElementById('attendanceList');
        list.innerHTML = data.map(user => `
            <div class="attendance-item">
                <input 
                    type="checkbox" 
                    ${user.attended ? 'checked' : ''}
                    data-user-id="${user.id}"
                >
                <label>${user.last_name} ${user.first_name}</label>
            </div>
        `).join('');
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    document.getElementById('attendanceList').addEventListener('change', async (e) => {
        const eventId = document.getElementById('eventFilter').value;
        const checkboxes = document.querySelectorAll('#attendanceList input[type="checkbox"]');
        const userIds = Array.from(checkboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.dataset.userId);

        await fetch(`/admin/attendance/${eventId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userIds })
        });
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
        // –ü–æ–ª—É—á–∞–µ–º —Ö—ç—à –∏–∑ URL –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º #users –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const hash = window.location.hash || '#users';
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–∫–ª–∞–¥–æ–∫ –∏ –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        const tabs = document.querySelectorAll('.tab-link');
        const panes = document.querySelectorAll('.tab-pane');

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        tabs.forEach(tab => tab.classList.remove('active'));
        panes.forEach(pane => pane.classList.remove('active'));

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É –ø–æ —Ö—ç—à—É
        const activeTab = document.querySelector(`.tab-link[href="${hash}"]`);
        const activePane = document.querySelector(hash);

        if (activeTab && activePane) {
            activeTab.classList.add('active');
            activePane.classList.add('active');
        } else {
            // –ï—Å–ª–∏ —Ö—ç—à –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –≤–∫–ª–∞–¥–∫—É
            tabs[0].classList.add('active');
            panes[0].classList.add('active');
            window.location.hash = tabs[0].getAttribute('href');
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
    document.querySelectorAll('.tab-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('href');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.querySelectorAll('.tab-link, .tab-pane').forEach(el => {
                el.classList.remove('active');
            });

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            link.classList.add('active');
            document.querySelector(targetId).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ö—ç—à –≤ URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            history.replaceState(null, null, targetId);
        });
    });

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    function openEditForm(id, title, description, date, locationId, maxParticipants) {
        document.getElementById('editEventId').value = id;
        document.getElementById('editEventTitle').value = title;
        document.getElementById('editEventDescription').value = description;
        document.getElementById('editEventDate').value = date;
        document.getElementById('editEventLocation').value = locationId;
        document.getElementById('editEventMaxParticipants').value = maxParticipants;
        openModal('editEventModal');
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏
    function openLocationEdit(id, metro, address) {
        document.getElementById('editLocationId').value = id;
        document.getElementById('editMetroStation').value = metro;
        document.getElementById('editAddress').value = address;
        openModal('editLocationModal');
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–æ–π —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
    function toggleEventForm() {
        const form = document.getElementById('eventForm');
        form.classList.toggle('hidden-form');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    function showAttendance(eventId) {
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        document.querySelectorAll('.tab-link, .tab-pane').forEach(el => {
            el.classList.remove('active');
        });
        document.querySelector('#attendance').classList.add('active');
        document.querySelector('a[href="#attendance"]').classList.add('active');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
        document.getElementById('eventFilter').value = eventId;
        
        // –ò–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è select
        document.getElementById('eventFilter').dispatchEvent(new Event('change'));
    }

    // –û–±–Ω–æ–≤–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è select
    document.getElementById('eventFilter').addEventListener('change', async (e) => {
        const eventId = e.target.value;
        const response = await fetch(`/admin/attendance/${eventId}`);
        if (!response.ok) return;
        
        const data = await response.json();
        const list = document.getElementById('attendanceList');
        list.innerHTML = data.map(user => `
            <div class="attendance-item">
                <input 
                    type="checkbox" 
                    ${user.attended ? 'checked' : ''}
                    data-user-id="${user.id}"
                >
                <label>${user.last_name} ${user.first_name}</label>
            </div>
        `).join('');
    });

     // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —É–ª–∏—Ü –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–∞
    document.getElementById('citySelect').addEventListener('change', async function(e) {
        const cityId = e.target.value;
        const response = await fetch(`/admin/streets?city_id=${cityId}`);
        const streets = await response.json();
        const streetSelect = document.getElementById('streetSelect');
        
        streetSelect.innerHTML = streets.map(street => 
            `<option value="${street.id}">${street.name}</option>`
        ).join('');
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–ª–∏—Ü –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('DOMContentLoaded', async () => {
        const citySelect = document.getElementById('citySelect');
        if (citySelect.value) {
            const response = await fetch(`/admin/streets?city_id=${citySelect.value}`);
            const streets = await response.json();
            const streetSelect = document.getElementById('streetSelect');
            streetSelect.innerHTML = streets.map(street => 
                `<option value="${street.id}">${street.name}</option>`
            ).join('');
        }
    });
</script>

<%- include('partials/footer') %>